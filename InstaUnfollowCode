(()=>{
  "use strict";

  if(location.hostname!=="www.instagram.com"){
    alert("Can be used only on Instagram routes");
    return;
  }

  const RESULTS_PER_PAGE=50;
  const SCAN_PAGE_SIZE=50;
  const SCAN_DELAY_MIN_MS=700;
  const SCAN_DELAY_JITTER_MS=600;
  const WHITELIST_KEY="iu_whitelisted-results";
  const GENDER_TAGS_KEY="iu_gender-tags";
  const GEMINI_KEY_STORAGE="iu_gemini_api_key";
  const GEMINI_BATCH_SIZE_KEY="iu_gemini_batch_size";
  const GEMINI_BATCH_SIZE_DEFAULT=50;
  const GEMINI_MODELS=[
    "gemini-3-flash-preview",
    "gemini-3.1-flash-image-preview",
    "gemini-3.1-pro-preview",
    "gemini-3-pro-image-preview",
  ];

  const css=`
  :root{
    --iu-bg:#111;
    --iu-panel:#1b1b1b;
    --iu-panel-2:#222;
    --iu-border:#333;
    --iu-border-2:#444;
    --iu-text:#fff;
    --iu-muted:#bdbdbd;
    --iu-danger:#ac2626;
    --iu-success:#56d756;
    --iu-accent:#49adf4;
  }

  *{box-sizing:border-box}
  html{background-color:var(--iu-bg) !important}
  html body{margin:0}

  html .iu{font-family:system-ui;color:var(--iu-text)}
  html .iu a{color:inherit;text-decoration-color:rgba(0,0,0,0);transition:text-decoration-color .1s;cursor:pointer}
  html .iu a:hover{text-decoration-color:inherit}

  .flex{display:flex}
  .column{flex-direction:column}
  .align-center{align-items:center}
  .justify-center{justify-content:center}
  .grow{flex:1}
  .w-100{width:100%}
  .t-center{text-align:center}
  .m-clear{margin:0}
  .p-clear{padding:0}
  .m-small{margin:.5rem}

  html .iu .overlay{min-height:100vh}
  html .iu .overlay{padding-top:4rem}

  html .iu .app-header{position:fixed;top:0;left:0;right:0;height:4rem;background-color:rgba(34,34,34,.95);backdrop-filter:blur(8px);z-index:5;border-bottom:1px solid var(--iu-border)}
  html .iu .progressbar{width:100%;height:6px;position:absolute;bottom:0;left:0}

  html .iu .app-header-content{max-width:1300px;margin:0 auto;height:100%;padding:0 1rem;gap:1rem;display:grid;grid-template-columns:auto 1fr auto;align-items:center}

  html .iu .header-left{gap:.75rem}
  html .iu .header-center{justify-content:center}
  html .iu .header-right{gap:.5rem;justify-content:flex-end;flex-wrap:wrap}

  html .iu .app-header .logo{font-size:1.1rem;letter-spacing:1px;font-weight:600;cursor:pointer;white-space:nowrap}
  html .iu .app-header .search-bar{width:min(520px,100%);color:var(--iu-text);border-radius:10px;padding:.55rem .75rem;font-weight:600;font-family:inherit;background-color:rgba(0,0,0,.15);border:1px solid var(--iu-border-2);outline:none}
  html .iu .app-header .search-bar:focus{border-color:var(--iu-accent)}

  html .iu button{background:none;border:none;cursor:pointer;color:inherit}
  html .iu button:disabled{opacity:.5;cursor:not-allowed}

  html .iu .btn{border:1px solid var(--iu-border-2);background:rgba(0,0,0,.15);border-radius:12px;padding:.45rem .65rem;font-weight:700}
  html .iu .btn-danger{background:var(--iu-danger);border-color:var(--iu-danger)}

  html .iu .pill{border:1px solid var(--iu-border-2);background:rgba(0,0,0,.15);border-radius:999px;padding:.3rem .55rem;font-weight:700;color:var(--iu-muted)}

  html .iu .shell{max-width:1300px;margin:0 auto;display:grid;grid-template-columns:320px 1fr;gap:0}
  html .iu .with-app-header{padding-top:4rem !important}
  html .iu .app-sidebar{position:sticky;top:4rem;align-self:start;height:calc(100vh - 4rem);overflow:auto;min-width:320px;border-inline-end:1px solid var(--iu-border);background:linear-gradient(180deg,var(--iu-panel),var(--iu-bg))}
  html .iu .sidebar-inner{padding:1rem}
  html .iu .sidebar-title{color:var(--iu-muted);font-weight:800;letter-spacing:.5px;margin:.25rem 0 .75rem 0}

  html .iu label{cursor:pointer}
  html .iu input[type=checkbox]{height:1.1rem;width:1.1rem}

  html .iu .badge{background:rgba(0,0,0,.15);border:1px solid var(--iu-border-2);border-radius:12px;padding:.5rem .65rem;display:flex;gap:.5rem;align-items:center;font-weight:700}
  html .iu .badge select{background:transparent;border:1px solid var(--iu-border-2);border-radius:10px;color:inherit;padding:.35rem .5rem}

  html .iu .results-container{padding:1rem;background:var(--iu-bg)}
  html .iu .tabs-container{display:flex;gap:.5rem;padding:1rem 0;position:sticky;top:4rem;background:var(--iu-bg);z-index:2;border-bottom:1px solid var(--iu-border)}
  html .iu .tabs-container .tab{flex:1;color:var(--iu-muted);border:1px solid var(--iu-border-2);border-radius:12px;cursor:pointer;padding:.65rem .75rem;text-align:center;font-weight:800}
  html .iu .tabs-container .tab-active{color:var(--iu-text);background-color:var(--iu-panel-2)}

  html .iu .alphabet-character{margin:1rem 0 .5rem 0;color:var(--iu-muted);font-weight:900;border-bottom:1px solid var(--iu-border);padding-bottom:.35rem}

  html .iu .result-item{display:grid;grid-template-columns:84px 1fr auto;gap:.75rem;align-items:center;border:1px solid var(--iu-border);background:linear-gradient(180deg,var(--iu-panel),rgba(0,0,0,.05));border-radius:14px;padding:.75rem;margin:.5rem 0}
  html .iu .result-item:hover{border-color:var(--iu-border-2)}
  html .iu .result-item:has(.account-checkbox:checked){border-color:var(--iu-accent)}
  html .iu .result-item:has(.account-checkbox:checked) .username{color:var(--iu-accent)}
  html .iu .avatar-container{position:relative;width:75px;height:75px}
  html .iu .avatar{width:75px;height:75px;border-radius:50%;object-fit:cover}
  html .iu .avatar-icon-overlay-container{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s;background:rgba(0,0,0,.55);border-radius:50%}
  html .iu .avatar-container:hover .avatar-icon-overlay-container{opacity:1}

  html .iu .result-meta{display:flex;flex-direction:column;gap:.15rem;min-width:0}
  html .iu .result-meta .username{font-size:1.4rem;font-weight:900;line-height:1.1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  html .iu .result-meta .fullname{color:var(--iu-muted);font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  html .iu .result-badges{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-top:.25rem}
  html .iu .verified-badge{background-color:var(--iu-accent);border-radius:999px;padding:.15rem .4rem;font-size:.8rem;font-weight:900}
  html .iu .private-indicator{border:1px solid var(--iu-success);border-radius:999px;color:var(--iu-success);font-weight:900;padding:.15rem .45rem;font-size:.8rem}

  html .iu .result-actions{display:flex;gap:.5rem;align-items:center}
  html .iu .account-checkbox{height:1.35rem;width:1.35rem}

  html .iu .toast{position:fixed;bottom:1rem;left:1rem;color:#000;background-color:#fff;border-radius:12px;font-size:1.05rem;z-index:10;padding:1rem 1.25rem;max-width:min(620px, calc(100vw - 2rem))}

  html .iu button.run-scan{position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);font-size:2em;color:#fff;border:1px solid #fff;height:160px;width:160px;border-radius:50%;background:rgba(0,0,0,.15)}

  html .iu .unfollow-log-container{padding:1rem;background:var(--iu-bg)}
  .p-medium{padding:.75rem}
  .fs-large{font-size:1.25rem;font-weight:900}
  .clr-inherit{color:inherit}
  .clr-red{color:var(--iu-danger)}
  .clr-green{color:var(--iu-success)}
  .clr-cyan{color:aqua}
  `;

  function injectStyles(){
    const style=document.createElement("style");
    style.textContent=css;
    document.head.appendChild(style);
  }

  function getCookie(name){
    const parts=(`; ${document.cookie}`).split(`; ${name}=`);
    if(parts.length!==2) return null;
    return parts.pop().split(";").shift()||null;
  }

  function sleep(ms){
    return new Promise(resolve=>setTimeout(resolve,ms));
  }

  function urlGenerator(after){
    const id=getCookie("ds_user_id");
    if(!after){
      return `https://www.instagram.com/graphql/query/?query_hash=3dec7e2c57367ef3da3d987d89f9dbc8&variables=${encodeURIComponent(JSON.stringify({id,include_reel:"true",fetch_mutual:"false",first:String(SCAN_PAGE_SIZE)}))}`;
    }
    return `https://www.instagram.com/graphql/query/?query_hash=3dec7e2c57367ef3da3d987d89f9dbc8&variables=${encodeURIComponent(JSON.stringify({id,include_reel:"true",fetch_mutual:"false",first:String(SCAN_PAGE_SIZE),after}))}`;
  }

  function unfollowUrl(id){
    return `https://www.instagram.com/web/friendships/${id}/unfollow/`;
  }

  function safeLower(str){
    return (str||"").toString().toLowerCase();
  }

  function loadWhitelist(){
    try{
      const raw=localStorage.getItem(WHITELIST_KEY);
      const arr=raw?JSON.parse(raw):[];
      return Array.isArray(arr)?arr:[];
    }catch{
      return [];
    }
  }

  function saveWhitelist(list){
    localStorage.setItem(WHITELIST_KEY,JSON.stringify(list));
  }

  function loadGenderTags(){
    try{
      const raw=localStorage.getItem(GENDER_TAGS_KEY);
      const obj=raw?JSON.parse(raw):{};
      return obj&&typeof obj==="object"?obj:{};
    }catch{
      return {};
    }
  }

  function saveGenderTags(tags){
    localStorage.setItem(GENDER_TAGS_KEY,JSON.stringify(tags));
  }

  function loadGeminiKey(){
    return localStorage.getItem(GEMINI_KEY_STORAGE)||"";
  }

  function saveGeminiKey(key){
    localStorage.setItem(GEMINI_KEY_STORAGE,key);
  }

  function loadGeminiBatchSize(){
    const raw=localStorage.getItem(GEMINI_BATCH_SIZE_KEY);
    const n=parseInt(raw,10);
    return (!isNaN(n)&&n>=1&&n<=200)?n:GEMINI_BATCH_SIZE_DEFAULT;
  }

  function saveGeminiBatchSize(n){
    localStorage.setItem(GEMINI_BATCH_SIZE_KEY,String(n));
  }

  function pagesFor(count){
    const pages=Math.ceil(count/RESULTS_PER_PAGE);
    return pages<1?1:pages;
  }

  function createUserCheckIcon(){
    const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("width","35");
    svg.setAttribute("height","35");
    svg.setAttribute("viewBox","0 0 24 24");
    svg.setAttribute("fill","none");
    svg.setAttribute("stroke","currentColor");
    svg.setAttribute("stroke-width","2");
    svg.setAttribute("stroke-linecap","round");
    svg.setAttribute("stroke-linejoin","round");
    const p1=document.createElementNS(svg.namespaceURI,"path");
    p1.setAttribute("d","M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2");
    const c1=document.createElementNS(svg.namespaceURI,"circle");
    c1.setAttribute("cx","8.5");
    c1.setAttribute("cy","7");
    c1.setAttribute("r","4");
    const pl=document.createElementNS(svg.namespaceURI,"polyline");
    pl.setAttribute("points","17 11 19 13 23 9");
    svg.append(p1,c1,pl);
    return svg;
  }

  function createUserUncheckIcon(){
    const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("width","35");
    svg.setAttribute("height","35");
    svg.setAttribute("viewBox","0 0 24 24");
    svg.setAttribute("fill","none");
    svg.setAttribute("stroke","currentColor");
    svg.setAttribute("stroke-width","2");
    svg.setAttribute("stroke-linecap","round");
    svg.setAttribute("stroke-linejoin","round");
    const p1=document.createElementNS(svg.namespaceURI,"path");
    p1.setAttribute("d","M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2");
    const c1=document.createElementNS(svg.namespaceURI,"circle");
    c1.setAttribute("cx","8.5");
    c1.setAttribute("cy","7");
    c1.setAttribute("r","4");
    const l1=document.createElementNS(svg.namespaceURI,"line");
    l1.setAttribute("x1","18");
    l1.setAttribute("y1","8");
    l1.setAttribute("x2","23");
    l1.setAttribute("y2","13");
    const l2=document.createElementNS(svg.namespaceURI,"line");
    l2.setAttribute("x1","23");
    l2.setAttribute("y1","8");
    l2.setAttribute("x2","18");
    l2.setAttribute("y2","13");
    svg.append(p1,c1,l1,l2);
    return svg;
  }

  function el(tag,attrs,...children){
    const node=document.createElement(tag);
    if(attrs){
      for(const [key,val] of Object.entries(attrs)){
        if(val===undefined||val===null) continue;
        if(key==="className") node.className=val;
        else if(key==="text") node.textContent=val;
        else if(key==="html") node.innerHTML=val;
        else if(key.startsWith("on")&&typeof val==="function") node.addEventListener(key.slice(2).toLowerCase(),val);
        else if(key==="disabled") node.disabled=!!val;
        else if(key==="checked") node.checked=!!val;
        else if(key==="value") node.value=val;
        else node.setAttribute(key,String(val));
      }
    }
    for(const child of children.flat()){
      if(child===undefined||child===null) continue;
      if(typeof child==="string") node.appendChild(document.createTextNode(child));
      else node.appendChild(child);
    }
    return node;
  }

  document.title="InstagramUnfollowersbyIbrahim";
  document.body.innerHTML="";
  injectStyles();

  const root=el("main",{id:"main",role:"main",className:"iu"});
  document.body.appendChild(root);

  const state={
    status:"initial",
    percentage:0,
    page:1,
    searchTerm:"",
    currentTab:"non_whitelisted",
    results:[],
    selectedIds:new Set(),
    whitelist:loadWhitelist(),
    genderTags:loadGenderTags(),
    filter:{
      showNonFollowers:true,
      showFollowers:false,
      showVerified:true,
      showPublic:true,
      showPrivate:true,
      showMale:true,
      showFemale:true,
      showUnknown:true,
      showSelectedOnly:false,
    },
    toast:{show:false,text:""},
    unfollowLog:[],
    logFilter:{showSucceeded:true,showFailed:true},
    geminiApiKey:loadGeminiKey(),
    geminiBatchSize:loadGeminiBatchSize(),
  };

  function toast(text){
    state.toast={show:true,text};
    render();
  }

  function hideToast(){
    if(!state.toast.show) return;
    state.toast={show:false,text:""};
    render();
  }

  function setStatus(newStatus){
    state.status=newStatus;
    render();
  }

  function whitelistIdSet(){
    return new Set(state.whitelist.map(u=>u.id));
  }

  function computeFilteredUsers({ignoreSelectedOnly=false}={}){
    const whitelistIds=whitelistIdSet();
    const term=safeLower(state.searchTerm);
    const f=state.filter;
    const tags=state.genderTags||{};

    let list=state.results;
    if(state.currentTab==="non_whitelisted"){
      list=list.filter(u=>!whitelistIds.has(u.id));
    }else{
      list=list.filter(u=>whitelistIds.has(u.id));
    }

    list=list.filter(u=>{
      if(!f.showPrivate && u.is_private) return false;
      if(!f.showPublic && !u.is_private) return false;
      if(!f.showVerified && u.is_verified) return false;
      if(!f.showFollowers && u.follows_viewer) return false;
      if(!f.showNonFollowers && !u.follows_viewer) return false;
      if(term){
        const u1=safeLower(u.username);
        const n1=safeLower(u.full_name);
        if(!u1.includes(term) && !n1.includes(term)) return false;
      }
      const g=(tags && tags[u.id])?tags[u.id]:"u";
      if(g==="m" && !f.showMale) return false;
      if(g==="f" && !f.showFemale) return false;
      if(g==="u" && !f.showUnknown) return false;
      return true;
    });

    if(!ignoreSelectedOnly && state.filter.showSelectedOnly){
      list=list.filter(u=>state.selectedIds.has(u.id));
    }
    return list;
  }

  function clearSelection(){
    state.selectedIds=new Set();
    render();
  }

  function toggleSelect(id,checked){
    const next=new Set(state.selectedIds);
    if(checked) next.add(id);
    else next.delete(id);
    state.selectedIds=next;
    render();
  }

  function setGenderTag(id,val){
    const next={...(state.genderTags||{})};
    next[id]=val;
    state.genderTags=next;
    saveGenderTags(next);
    render();
  }

  function toggleWhitelist(user){
    const list=state.whitelist.slice();
    const idx=list.findIndex(u=>u.id===user.id);
    if(idx>=0) list.splice(idx,1);
    else list.push(user);
    state.whitelist=list;
    saveWhitelist(list);
    render();
  }

  function updateFilter(name,checked){
    if(state.status!=="scanning") return;
    if(state.selectedIds.size>0){
      const ok=confirm("Changing filter options will clear selected users");
      if(!ok){
        render();
        return;
      }
    }
    state.selectedIds=new Set();
    state.filter={...state.filter,[name]:checked};
    state.page=1;
    render();
  }

  function updateLogFilter(name,checked){
    if(state.status!=="unfollowing") return;
    state.logFilter={...state.logFilter,[name]:checked};
    render();
  }

  function setSearchTerm(val){
    if(state.status==="initial") return;
    state.searchTerm=val;
    state.page=1;
    render();
  }

  async function startScan(){
    if(state.status!=="initial") return;
    state.status="scanning";
    state.percentage=0;
    state.page=1;
    state.searchTerm="";
    state.currentTab="non_whitelisted";
    state.results=[];
    state.selectedIds=new Set();
    state.genderTags=loadGenderTags();
    state.whitelist=loadWhitelist();
    state.filter={
      showNonFollowers:true,
      showFollowers:false,
      showVerified:true,
      showPublic:true,
      showPrivate:true,
      showMale:true,
      showFemale:true,
      showUnknown:true,
      showSelectedOnly:false,
    };
    render();

    const collected=[];
    const seenIds=new Set();
    let url=urlGenerator();
    let hasNext=true;
    let fetchedCount=0;
    let totalCount=-1;
    let safetyCounter=0;

    while(hasNext){
      let edgeFollow;
      try{
        const res=await fetch(url);
        if(res.status===429){
          toast("Rate limited (HTTP 429). Sleeping 60s...");
          await sleep(60000);
          hideToast();
          continue;
        }
        if(!res.ok){
          toast(`Scan request failed (HTTP ${res.status}). Retrying...`);
          await sleep(5000);
          hideToast();
          continue;
        }

        const json=await res.json();
        edgeFollow=json?.data?.user?.edge_follow;
        if(!edgeFollow) throw new Error("Unexpected response shape");
      }catch(err){
        console.error(err);
        continue;
      }

      if(totalCount===-1) totalCount=edgeFollow.count;
      hasNext=!!edgeFollow.page_info?.has_next_page;
      const endCursor=edgeFollow.page_info?.end_cursor;
      url=urlGenerator(endCursor);

      for(const edge of edgeFollow.edges||[]){
        const node=edge?.node;
        if(!node||!node.id) continue;
        if(seenIds.has(node.id)) continue;
        seenIds.add(node.id);
        collected.push(node);
      }
      fetchedCount+=edgeFollow.edges?.length||0;

      const pct=(totalCount>0)?Math.floor((fetchedCount/totalCount)*100):0;
      state.results=collected.slice();
      state.percentage=Math.min(100,Math.max(0,pct));
      render();

      await sleep(SCAN_DELAY_MIN_MS+Math.floor(SCAN_DELAY_JITTER_MS*Math.random()));
      safetyCounter+=1;
      if(safetyCounter>6){
        safetyCounter=0;
        toast("Sleeping 10 secs to prevent getting temp blocked");
        await sleep(10000);
        hideToast();
      }
    }

    state.percentage=100;
    render();
  }

  async function copyList(){
    if(state.status!=="scanning") return;
    const list=state.filter.showSelectedOnly
      ? state.results.filter(u=>state.selectedIds.has(u.id))
      : computeFilteredUsers({ignoreSelectedOnly:true});
    const sorted=list.slice().sort((a,b)=>a.username>b.username?1:-1);
    const text=sorted.map(u=>u.username).join("\n")+"\n";
    await navigator.clipboard.writeText(text);
    alert("List copied to clipboard!");
  }

  async function unfollowSelected(){
    if(state.status!=="scanning") return;
    if(state.selectedIds.size===0){
      alert("Must select at least a single user to unfollow");
      return;
    }
    const ok=confirm(`Unfollow ${state.selectedIds.size} users?`);
    if(!ok) return;

    const csrf=getCookie("csrftoken");
    if(!csrf){
      toast("Missing csrftoken cookie. Refresh Instagram and try again.");
      await sleep(2000);
      hideToast();
      setStatus("initial");
      return;
    }

    state.status="unfollowing";
    state.percentage=0;
    state.unfollowLog=[];
    state.logFilter={showSucceeded:true,showFailed:true};
    render();

    const selectedUsers=state.results.filter(u=>state.selectedIds.has(u.id));
    let index=0;
    for(const user of selectedUsers){
      index+=1;
      const pct=Math.floor((index/selectedUsers.length)*100);
      state.percentage=pct;

      try{
        const res=await fetch(unfollowUrl(user.id),{
          headers:{
            "content-type":"application/x-www-form-urlencoded",
            "x-csrftoken":csrf,
          },
          method:"POST",
          mode:"cors",
          credentials:"include",
        });
        if(!res.ok){
          state.unfollowLog=[...state.unfollowLog,{user,unfollowedSuccessfully:false,statusCode:res.status}];
        }else{
          state.unfollowLog=[...state.unfollowLog,{user,unfollowedSuccessfully:true}];
        }
      }catch(err){
        console.error(err);
        state.unfollowLog=[...state.unfollowLog,{user,unfollowedSuccessfully:false}];
      }

      render();

      if(index!==selectedUsers.length){
        await sleep(Math.floor(2000*Math.random())+4000);
        if(index%5===0){
          toast("Sleeping 5 minutes to prevent getting temp blocked");
          await sleep(300000);
          hideToast();
        }
      }
    }

    state.percentage=100;
    render();
  }

  async function autoTagGender(){
    if(state.status!=="scanning") return;
    const key=state.geminiApiKey;
    if(!key){alert("Paste a Gemini API key in the sidebar first.");return;}

    const untagged=state.results.filter(u=>{
      const g=state.genderTags?.[u.id];
      return !g||g==="u";
    });
    if(untagged.length===0){alert("All users are already tagged.");return;}

    const chunks=[];
    const batchSize=state.geminiBatchSize||GEMINI_BATCH_SIZE_DEFAULT;
    for(let i=0;i<untagged.length;i+=batchSize) chunks.push(untagged.slice(i,i+batchSize));

    let taggedCount=0;
    const next={...(state.genderTags||{})};

    const SAFETY_SETTINGS=[
      {category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_ONLY_HIGH"},
      {category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_ONLY_HIGH"},
      {category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_ONLY_HIGH"},
      {category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_ONLY_HIGH"},
    ];

    const SYSTEM_INSTRUCTION={
      parts:[{text:
        "You are a name-linguistics classifier. "+
        "Given a list of name strings, you classify each name's conventional gender association based on linguistics and cultural naming conventions only — you are NOT making claims about any real person. "+
        "Output strictly valid JSON. No prose, no markdown fences."
      }]
    };

    async function tryModel(model,payload){
      const userText=
        "Classify the conventional gender association of each name string below.\n"+
        "Rules:\n"+
        "  - Use \"m\" for names conventionally masculine (e.g. Ahmed, David, Ivan)\n"+
        "  - Use \"f\" for names conventionally feminine (e.g. Sara, Maria, Fatima)\n"+
        "  - Use \"u\" for unisex names, pure usernames with no recognisable name, or uncertain cases\n"+
        "Respond ONLY with a compact JSON object: {\"<id>\":\"m\"|\"f\"|\"u\", ...}\n"+
        "No extra text. No markdown.\n\n"+
        "Names to classify:\n"+
        JSON.stringify(payload.map(u=>({id:u.id,name:(u.full_name||u.username||"").trim()})));
      try{
        const res=await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`,
          {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              systemInstruction:SYSTEM_INSTRUCTION,
              contents:[{role:"user",parts:[{text:userText}]}],
              generationConfig:{temperature:0,responseMimeType:"application/json"},
              safetySettings:SAFETY_SETTINGS,
            }),
          }
        );
        if(!res.ok){console.warn(`Gemini [${model}] HTTP ${res.status}`);return null;}
        const json=await res.json();
        const finishReason=json?.candidates?.[0]?.finishReason;
        if(finishReason==="SAFETY"||finishReason==="RECITATION"){
          console.warn(`Gemini [${model}] blocked: finishReason=${finishReason}`);
          return null;
        }
        let raw=json?.candidates?.[0]?.content?.parts?.[0]?.text||"";
        raw=raw.replace(/```[a-z]*\n?/gi,"").trim();
        try{return JSON.parse(raw);}catch{return null;}
      }catch(err){
        console.warn(`Gemini [${model}] network error`,err);
        return null;
      }
    }

    for(let ci=0;ci<chunks.length;ci++){
      const chunk=chunks[ci];
      const payload=chunk.map(u=>({id:u.id,username:u.username,full_name:u.full_name||""}));
      let parsed=null;
      for(const model of GEMINI_MODELS){
        toast(`AI tagging batch ${ci+1} / ${chunks.length} (${model})...`);
        parsed=await tryModel(model,payload);
        if(parsed&&typeof parsed==="object") break;
        await sleep(800);
      }
      if(!parsed){
        toast(`All models failed on batch ${ci+1}. Skipping.`);
        await sleep(2500);
        hideToast();
        continue;
      }
      for(const [id,val] of Object.entries(parsed)){
        if(val==="m"||val==="f"||val==="u"){next[id]=val;taggedCount++;}
      }
      state.genderTags={...next};
      saveGenderTags(state.genderTags);
      render();
      if(ci<chunks.length-1) await sleep(500);
    }

    toast(`AI tagging complete! Tagged ${taggedCount} users.`);
    await sleep(3000);
    hideToast();
  }

  function buildHeader(filteredAllNoSelectedOnly){
    const showProgress=(state.status==="scanning"||state.status==="unfollowing") && state.percentage<100;
    const header=el("header",{className:"app-header"});
    if(showProgress){
      const progress=el("progress",{className:"progressbar"});
      progress.max="100";
      progress.value=String(state.percentage);
      header.appendChild(progress);
    }

    const content=el("div",{className:"app-header-content"});
    const logo=el("div",{className:"logo",text:"InstagramUnfollowersby@ibrahimmmm._",onClick:()=>{
      if(state.status==="initial"){
        if(confirm("Go back to Instagram?")) location.reload();
      }else{
        state.status="initial";
        render();
      }
    }});

    const copyBtn=el("button",{className:"btn",text:"COPY LIST",disabled:state.status!=="scanning",onClick:()=>copyList()});
    const search=el("input",{type:"text",className:"search-bar",placeholder:"Search...",disabled:state.status==="initial",value:state.status==="initial"?"":state.searchTerm,onInput:(e)=>setSearchTerm(e.currentTarget.value)});

    const left=el("div",{className:"header-left flex align-center"});
    left.appendChild(logo);

    const center=el("div",{className:"header-center flex align-center"});
    center.appendChild(search);

    const right=el("div",{className:"header-right flex align-center"});
    right.appendChild(copyBtn);

    if(state.status==="scanning"){
      right.appendChild(el("span",{className:"pill",text:`Selected: ${state.selectedIds.size}`}));

      const clearBtn=el("button",{className:"btn",text:"Clear",disabled:state.selectedIds.size===0,onClick:()=>clearSelection()});
      const unfollowBtn=el("button",{className:"btn btn-danger",text:`UNFOLLOW (${state.selectedIds.size})`,disabled:state.selectedIds.size===0,onClick:()=>unfollowSelected()});
      right.appendChild(clearBtn);
      right.appendChild(unfollowBtn);

      const selectAllLabel=el("label",{className:"badge"});
      const selectAllInput=el("input",{type:"checkbox",className:"toggle-all-checkbox"});
      selectAllInput.disabled=state.percentage<100 || filteredAllNoSelectedOnly.length===0;
      selectAllInput.checked=filteredAllNoSelectedOnly.length>0 && state.selectedIds.size===filteredAllNoSelectedOnly.length;
      selectAllInput.addEventListener("change",(e)=>{
        if(state.status!=="scanning") return;
        const checked=e.currentTarget.checked;
        if(checked){
          const next=new Set(filteredAllNoSelectedOnly.map(u=>u.id));
          state.selectedIds=next;
        }else{
          state.selectedIds=new Set();
        }
        render();
      });
      selectAllLabel.appendChild(selectAllInput);
      selectAllLabel.appendChild(document.createTextNode(" Select all (filtered)"));
      right.appendChild(selectAllLabel);
    }

    content.appendChild(left);
    content.appendChild(center);
    content.appendChild(right);

    header.appendChild(content);
    return header;
  }

  function buildSidebar(filteredDisplayed,filteredAll){
    const aside=el("aside",{className:"app-sidebar"});
    const inner=el("div",{className:"sidebar-inner"});
    inner.appendChild(el("div",{className:"sidebar-title",text:"FILTERS"}));

    const menu=el("menu",{className:"flex column m-clear p-clear"});

    const f=state.filter;
    const addCheckbox=(name,labelText)=>{
      const label=el("label",{className:"badge m-small"});
      const input=el("input",{type:"checkbox"});
      input.name=name;
      input.checked=!!f[name];
      input.addEventListener("change",(e)=>updateFilter(name,e.currentTarget.checked));
      label.appendChild(input);
      label.appendChild(document.createTextNode(` ${labelText}`));
      menu.appendChild(label);
    };

    addCheckbox("showNonFollowers","Non-Followers");
    addCheckbox("showFollowers","Followers");
    addCheckbox("showVerified","Verified");
    addCheckbox("showPrivate","Private");
    addCheckbox("showPublic","Public");
    addCheckbox("showSelectedOnly","Selected Only");
    addCheckbox("showMale","Male");
    addCheckbox("showFemale","Female");
    addCheckbox("showUnknown","Unknown");

    inner.appendChild(menu);

    inner.appendChild(el("div",{className:"sidebar-title",text:"GEMINI AI"}));
    const keyInput=el("input",{type:"password",placeholder:"Paste Gemini API key...",value:state.geminiApiKey||""});
    keyInput.className="search-bar";
    keyInput.style.cssText="width:100%;margin:.25rem 0 .5rem 0;font-size:.85rem";
    keyInput.addEventListener("input",(e)=>{
      const v=e.currentTarget.value.trim();
      state.geminiApiKey=v;
      saveGeminiKey(v);
    });
    inner.appendChild(keyInput);

    const batchLabel=el("label",{className:"badge m-small",style:"flex-direction:column;align-items:flex-start;gap:.25rem"});
    batchLabel.appendChild(document.createTextNode("Batch size (1-200)"));
    const batchInput=el("input",{type:"number",min:"1",max:"200",value:String(state.geminiBatchSize)});
    batchInput.style.cssText="width:100%;background:transparent;border:1px solid var(--iu-border-2);border-radius:8px;color:inherit;padding:.3rem .5rem;font-size:.85rem";
    batchInput.addEventListener("change",(e)=>{
      let n=parseInt(e.currentTarget.value,10);
      if(isNaN(n)||n<1) n=1;
      if(n>200) n=200;
      e.currentTarget.value=String(n);
      state.geminiBatchSize=n;
      saveGeminiBatchSize(n);
    });
    batchLabel.appendChild(batchInput);
    inner.appendChild(batchLabel);

    const autoTagBtn=el("button",{className:"btn",text:"AUTO-TAG GENDER",disabled:state.status!=="scanning"||!state.geminiApiKey,onClick:()=>autoTagGender()});
    autoTagBtn.style.cssText="width:100%;margin:.5rem 0 .75rem 0";
    inner.appendChild(autoTagBtn);

    const summary=el("div",{className:"grow"});
    summary.appendChild(el("div",{className:"sidebar-title",text:"STATS"}));
    summary.appendChild(el("div",{className:"badge m-small",text:`Selected: ${state.selectedIds.size}`}));
    summary.appendChild(el("div",{className:"badge m-small",text:`Displayed: ${filteredDisplayed.length}`}));
    summary.appendChild(el("div",{className:"badge m-small",text:`Filtered: ${filteredAll.length}`}));
    summary.appendChild(el("div",{className:"badge m-small",text:`Total: ${state.results.length}`}));
    inner.appendChild(summary);

    const paging=el("div",{className:"grow t-center"});
    paging.appendChild(el("div",{className:"sidebar-title",text:"PAGES"}));
    const prev=el("a",{className:"btn",text:"❮",onClick:()=>{
      if(state.page-1>0){
        state.page-=1;
        render();
      }
    }});
    const next=el("a",{className:"btn",text:"❯",onClick:()=>{
      const totalPages=pagesFor(filteredDisplayed.length);
      if(state.page<totalPages){
        state.page+=1;
        render();
      }
    }});
    paging.appendChild(prev);
    paging.appendChild(el("span",{text:`${state.page} / ${pagesFor(filteredDisplayed.length)}`}));
    paging.appendChild(next);
    inner.appendChild(paging);

    aside.appendChild(inner);
    return aside;
  }

  function buildResults(filteredDisplayed,filteredAllNoSelectedOnly){
    const article=el("article",{className:"results-container"});
    const nav=el("nav",{className:"tabs-container"});

    const tab=(name,label)=>{
      const active=state.currentTab===name;
      return el("div",{className:`tab ${active?"tab-active":""}`,text:label,onClick:()=>{
        if(state.currentTab===name) return;
        state.currentTab=name;
        state.selectedIds=new Set();
        state.page=1;
        render();
      }});
    };
    nav.appendChild(tab("non_whitelisted","Non-Whitelisted"));
    nav.appendChild(tab("whitelisted","Whitelisted"));
    article.appendChild(nav);

    const sorted=filteredDisplayed.slice().sort((a,b)=>a.username>b.username?1:-1);
    const start=(state.page-1)*RESULTS_PER_PAGE;
    const slice=sorted.slice(start,start+RESULTS_PER_PAGE);

    let lastLetter="";
    for(const user of slice){
      const letter=(user.username||"").substring(0,1).toUpperCase();
      if(letter && letter!==lastLetter){
        lastLetter=letter;
        article.appendChild(el("div",{className:"alphabet-character",text:letter}));
      }

      const rowLabel=el("label",{className:"result-item"});

      const avatarContainer=el("div",{className:"avatar-container",onClick:(e)=>{
        e.preventDefault();
        e.stopPropagation();
        toggleWhitelist(user);
      }});
      const img=el("img",{className:"avatar",alt:user.username,src:user.profile_pic_url});
      const overlay=el("span",{className:"avatar-icon-overlay-container"});
      overlay.appendChild(state.currentTab==="non_whitelisted"?createUserCheckIcon():createUserUncheckIcon());
      avatarContainer.append(img,overlay);

      const meta=el("div",{className:"result-meta"});
      const link=el("a",{className:"username",target:"_blank",href:`../${user.username}`,rel:"noreferrer",text:user.username});
      const full=el("div",{className:"fullname",text:user.full_name||""});
      const badges=el("div",{className:"result-badges"});
      if(user.is_verified) badges.appendChild(el("span",{className:"verified-badge",text:"✔ Verified"}));
      if(user.is_private) badges.appendChild(el("span",{className:"private-indicator",text:"Private"}));
      meta.append(link,full,badges);

      const actions=el("div",{className:"result-actions"});

      const genderSelect=el("select",{className:"badge m-small"});
      genderSelect.value=(state.genderTags&&state.genderTags[user.id])?state.genderTags[user.id]:"u";
      genderSelect.addEventListener("click",(e)=>{e.preventDefault();e.stopPropagation();});
      genderSelect.addEventListener("change",(e)=>{
        e.preventDefault();
        e.stopPropagation();
        setGenderTag(user.id,e.currentTarget.value);
      });
      genderSelect.append(
        el("option",{value:"u",text:"?"}),
        el("option",{value:"m",text:"M"}),
        el("option",{value:"f",text:"F"}),
      );
      const cb=el("input",{type:"checkbox",className:"account-checkbox"});
      cb.checked=state.selectedIds.has(user.id);
      cb.addEventListener("change",(e)=>toggleSelect(user.id,e.currentTarget.checked));

      actions.appendChild(genderSelect);
      actions.appendChild(cb);

      rowLabel.appendChild(avatarContainer);
      rowLabel.appendChild(meta);
      rowLabel.appendChild(actions);

      article.appendChild(rowLabel);
    }

    return article;
  }

  function buildUnfollowLog(){
    const aside=el("aside",{className:"app-sidebar"});
    const menu=el("menu",{className:"flex column grow m-clear p-clear"});
    menu.appendChild(el("p",{text:"Filter"}));

    const add=(name,labelText)=>{
      const label=el("label",{className:"badge m-small"});
      const input=el("input",{type:"checkbox"});
      input.checked=!!state.logFilter[name];
      input.addEventListener("change",(e)=>updateLogFilter(name,e.currentTarget.checked));
      label.appendChild(input);
      label.appendChild(document.createTextNode(` ${labelText}`));
      menu.appendChild(label);
    };
    add("showSucceeded","Succeeded");
    add("showFailed","Failed");
    aside.appendChild(menu);

    const article=el("article",{className:"unfollow-log-container"});

    if(state.unfollowLog.length>0 && state.unfollowLog.length===state.unfollowLog.filter(Boolean).length && state.percentage>=100){
      article.appendChild(el("hr"));
      article.appendChild(el("div",{className:"fs-large p-medium clr-green",text:"All DONE!"}));
      article.appendChild(el("hr"));
    }

    const term=safeLower(state.searchTerm);
    const filtered=state.unfollowLog.filter(entry=>{
      if(!entry) return false;
      if(entry.unfollowedSuccessfully && !state.logFilter.showSucceeded) return false;
      if(!entry.unfollowedSuccessfully && !state.logFilter.showFailed) return false;
      if(term && !safeLower(entry.user?.username).includes(term)) return false;
      return true;
    });

    filtered.forEach((entry,idx)=>{
      const pos=` [${idx+1}/${state.unfollowLog.length}]`;
      if(entry.unfollowedSuccessfully){
        const line=el("div",{className:"p-medium"});
        line.appendChild(document.createTextNode("Unfollowed"));
        const a=el("a",{className:"clr-inherit",target:"_blank",href:`../${entry.user.username}`,rel:"noreferrer",text:` ${entry.user.username}`});
        line.appendChild(a);
        line.appendChild(el("span",{className:"clr-cyan",text:` ${pos}`}));
        article.appendChild(line);
      }else{
        const line=el("div",{className:"p-medium clr-red"});
        line.appendChild(document.createTextNode(`Failed to unfollow ${entry.user.username}`));
        if(entry.statusCode){
          line.appendChild(el("span",{className:"clr-cyan",text:` (HTTP ${entry.statusCode})`}));
        }
        line.appendChild(document.createTextNode(` ${pos}`));
        article.appendChild(line);
      }
    });

    const container=el("section",{className:"shell"},aside,article);
    return container;
  }

  function render(){
    root.innerHTML="";
    const overlay=el("section",{className:"overlay"});

    const filteredAllNoSelectedOnly = state.status==="scanning" ? computeFilteredUsers({ignoreSelectedOnly:true}) : [];
    const header=buildHeader(filteredAllNoSelectedOnly);
    overlay.appendChild(header);

    let mainContent;
    if(state.status==="initial"){
      mainContent=el("button",{className:"run-scan",text:"RUN",onClick:()=>startScan()});
      overlay.appendChild(mainContent);
    }else if(state.status==="scanning"){
      const filteredAll=computeFilteredUsers({ignoreSelectedOnly:false});
      const sidebar=buildSidebar(filteredAll,filteredAllNoSelectedOnly);
      const results=buildResults(filteredAll,filteredAllNoSelectedOnly);
      mainContent=el("section",{className:"shell"},sidebar,results);
      overlay.appendChild(mainContent);
    }else if(state.status==="unfollowing"){
      overlay.appendChild(buildUnfollowLog());
    }

    root.appendChild(overlay);
    if(state.toast.show){
      root.appendChild(el("div",{className:"toast",text:state.toast.text}));
    }
  }

  window.addEventListener("beforeunload",(e)=>{
    const prevent=(state.status==="scanning"||state.status==="unfollowing") && state.percentage<100;
    if(!prevent) return;
    e.preventDefault();
    e.returnValue="Changes you made may not be saved.";
  });

  render();
})();
